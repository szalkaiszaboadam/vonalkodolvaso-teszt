<!DOCTYPE html>
<html lang="hu">

<head>
    <meta charset="UTF-8">
    <meta name="viewport"
        content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <title>Leltár App Pro</title>
    <script src="https://unpkg.com/html5-qrcode" type="text/javascript"></script>
    <script src="https://cdn.sheetjs.com/xlsx-0.20.1/package/dist/xlsx.full.min.js"></script>
    <script src="https://unpkg.com/lucide@latest"></script>

    <style>
        * {
            box-sizing: border-box;
            -webkit-tap-highlight-color: transparent;
        }

        :root {
            --primary: #0044cc;
            /* Kék */
            --dark: #1a1a1a;
            /* Fekete/Sötétszürke */
            --danger: #cc0000;
            /* Piros */
            --grey: #888888;
            --light-grey: #f0f0f0;
            --bg: #ffffff;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif;
            margin: 0;
            padding: 0;
            background: #000;
            height: 100dvh;
            display: flex;
            flex-direction: column;
            overflow: hidden;
        }

        /* Navigáció */
        nav {
            display: flex;
            background: white;
            border-bottom: 1px solid var(--light-grey);
            z-index: 1000;
            padding-top: env(safe-area-inset-top);
            height: calc(70px + env(safe-area-inset-top));
        }

        .tab-btn {
            flex: 1;
            padding: 10px 5px;
            border: none;
            background: none;
            font-size: 11px;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            color: var(--grey);
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            gap: 6px;
            transition: 0.2s;
        }

        .tab-btn.active {
            color: var(--primary);
            font-weight: 700;
        }

        .tab-btn i {
            width: 20px;
            height: 20px;
        }

        /* Tartalom */
        .content-area {
            flex: 1;
            position: relative;
            display: none;
            background: var(--bg);
            overflow-y: auto;
        }

        .content-area.active {
            display: block;
        }

        /* Szkenner */
        #scanner {
            background: #000;
            overflow: hidden;
        }

        #reader {
            width: 100% !important;
            height: 100% !important;
            border: none !important;
        }

        #reader video {
            object-fit: cover !important;
            width: 100% !important;
            height: 100% !important;
        }

        /* Keret középre igazítva */
        .scan-overlay {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            width: 260px;
            height: 160px;
            border: 2px solid white;
            border-radius: 12px;
            box-shadow: 0 0 0 5000px rgba(0, 0, 0, 0.6);
            pointer-events: none;
            z-index: 5;
        }

        .camera-controls {
            position: absolute;
            bottom: 40px;
            left: 50%;
            transform: translateX(-50%);
            display: flex;
            gap: 25px;
            z-index: 100;
        }

        .control-btn {
            width: 56px;
            height: 56px;
            border-radius: 50%;
            background: rgba(255, 255, 255, 0.15);
            backdrop-filter: blur(10px);
            border: 1px solid rgba(255, 255, 255, 0.3);
            color: white;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
        }

        .control-btn.active {
            background: var(--primary);
            border-color: var(--primary);
        }

        /* Drawer */
        #backdrop {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.8);
            display: none;
            z-index: 1500;
        }

        #drawer {
            position: fixed;
            bottom: -100%;
            left: 0;
            right: 0;
            background: white;
            border-radius: 20px 20px 0 0;
            padding: 20px 25px calc(30px + env(safe-area-inset-bottom));
            transition: bottom 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            z-index: 2000;
        }

        #drawer.open {
            bottom: 0;
        }

        #backdrop.active {
            display: block;
        }

        .drawer-handle {
            width: 40px;
            height: 4px;
            background: var(--light-grey);
            border-radius: 2px;
            margin: 0 auto 20px;
        }

        #drawer-code {
            font-size: 1.8rem;
            font-weight: 700;
            color: var(--dark);
            margin-bottom: 5px;
            word-break: break-all;
        }

        #drawer-info {
            font-size: 1rem;
            color: var(--grey);
            margin-bottom: 25px;
        }

        .qty-input-large {
            width: 100%;
            max-width: 160px;
            height: 70px;
            font-size: 32px;
            text-align: center;
            border: 1px solid var(--light-grey);
            border-radius: 12px;
            font-weight: 700;
            background: var(--light-grey);
            margin-bottom: 15px;
            outline: none;
        }

        .qty-input-large:focus {
            border-color: var(--primary);
            background: white;
        }

        /* Listaelemek */
        .item-card {
            background: white;
            padding: 16px;
            border-radius: 0;
            margin-bottom: 0;
            display: flex;
            justify-content: space-between;
            align-items: center;
            border-bottom: 1px solid var(--light-grey);
        }

        /* Gombok */
        .btn {
            display: inline-flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
            padding: 12px 20px;
            border-radius: 8px;
            border: none;
            font-weight: 600;
            cursor: pointer;
            transition: 0.2s;
            font-size: 14px;
        }

        .btn-primary {
            background: var(--primary);
            color: white;
        }

        .btn-dark {
            background: var(--dark);
            color: white;
        }

        .btn-outline {
            background: white;
            color: var(--dark);
            border: 1px solid var(--light-grey);
        }

        .btn-danger {
            background: var(--danger);
            color: white;
        }

        .btn-ok-large {
            width: 100%;
            height: 60px;
            font-size: 16px;
            background: var(--dark);
            color: white;
            border-radius: 12px;
            border: none;
            font-weight: 700;
            text-transform: uppercase;
        }

        .qty-controls {
            display: flex;
            align-items: center;
            gap: 4px;
        }

        .btn-qty {
            width: 36px;
            height: 36px;
            padding: 0;
            border-radius: 6px;
        }

        h3 {
            margin: 0 0 20px 0;
            font-weight: 800;
            font-size: 24px;
        }

/* Duplikáció villanás és stílus */
@keyframes flash-yellow {
    0% { background-color: white; }
    50% { background-color: #fff3cd; }
    100% { background-color: white; }
}

.duplicate-active {
    animation: flash-yellow 1s ease-in-out;
    border-top: 5px solid #ffc107 !important;
}

.duplicate-text {
    color: #856404 !important;
    font-weight: bold;
    font-size: 0.85rem;
    display: block;
    margin-top: 8px;
    background: #fff3cd;
    padding: 4px;
    border-radius: 4px;
}

.qty-selector-container {
    width: 100%;
    overflow-x: auto;
    padding: 20px 0;
    margin-bottom: 5px;
    -webkit-overflow-scrolling: touch;
    display: flex;
    justify-content: flex-start;
    /* Eltüntetjük a görgetősávot */
    scrollbar-width: none; 
    background: linear-gradient(90deg, rgba(255,255,255,1) 0%, rgba(240,240,240,0) 50%, rgba(255,255,255,1) 100%);
}
.qty-selector-container::-webkit-scrollbar { display: none; }

.qty-ribbon {
    display: flex;
    gap: 12px;
    padding: 0 40%; /* Hogy az első és utolsó elem is középre kerülhessen */
}

.qty-chip {
    min-width: 60px;
    height: 60px;
    border-radius: 12px;
    background: white;
    color: var(--dark);
    display: flex;
    align-items: center;
    justify-content: center;
    font-weight: 700;
    font-size: 1.2rem;
    cursor: pointer;
    transition: 0.2s;
    border: 2px solid transparent;
    box-shadow: 0 2px 8px rgba(0,0,0,0.1);
}

.qty-chip.selected {
    background: var(--primary);
    color: white;
    transform: scale(1.1);
}


.picker-container {
    position: relative;
    height: 150px;
    width: 100%; /* Kitölti a szélességet, de a tartalom középen lesz */
    margin: 10px auto;
    overflow: hidden;
    touch-action: pan-y; /* CSAK függőleges érintést engedélyez */
    mask-image: linear-gradient(to bottom, transparent, black 30%, black 70%, transparent);
    -webkit-mask-image: linear-gradient(to bottom, transparent, black 30%, black 70%, transparent);
}

.picker-wheel {
    height: 100%;
    overflow-y: scroll;
    overflow-x: hidden !important;/* Vízszintes görgetés tiltása */
    scroll-snap-type: y mandatory;
    scrollbar-width: none;
    touch-action: pan-y !important;
    padding: 50px 0;
}

.picker-wheel::-webkit-scrollbar { display: none; }

.picker-item {
    height: 50px;
    width: 100%; /* Ne tudjon oldalra mozogni */
    display: flex;
    align-items: center;
    justify-content: center;
    font-size: 24px;
    font-weight: 800;
    color: var(--grey);
    scroll-snap-align: center;
}

.picker-item.active {
    color: var(--primary);
    transform: scale(1.2);
}

/* A kijelölő keret középen */
.picker-selection-frame {
    position: absolute;
    top: 50%;
    left: 0;
    right: 0;
    height: 50px;
    transform: translateY(-50%);
    border-top: 2px solid var(--light-grey);
    border-bottom: 2px solid var(--light-grey);
    pointer-events: none;
}

.picker-item input {
    width: 100%;
    height: 100%;
    background: transparent;
    border: none;
    text-align: center;
    font-size: 24px;
    font-weight: 800;
    font-family: inherit;
    color: inherit;
    outline: none;
    pointer-events: none; /* Alapból nem kattintható */
    opacity: 0.5; /* Kicsit elhalványítjuk, ha nincs középen */
    transition: 0.3s;
}

/* Eltüntetjük a nyilakat a számmezőből */
.picker-item input::-webkit-inner-spin-button,
.picker-item input::-webkit-outer-spin-button {
    -webkit-appearance: none;
    margin: 0;
}

.picker-item.active input {
    color: var(--primary);
    pointer-events: auto;
    opacity: 1;
}
    </style>
</head>

<body>

    <nav>
        <button class="tab-btn active" onclick="showTab('scanner', this)">
            <i data-lucide="scan"></i>Szkenner
        </button>
        <button class="tab-btn" onclick="showTab('list', this)">
            <i data-lucide="list"></i>Lista
        </button>
        <button class="tab-btn" onclick="showTab('settings', this)">
            <i data-lucide="settings"></i>Beállítások
        </button>
    </nav>

    <div id="scanner" class="content-area active">
        <div id="reader"></div>
        <div class="scan-overlay"></div>

        <div class="camera-controls">
            <button id="restart-cam-btn" class="control-btn" onclick="restartCamera()">
                <i data-lucide="refresh-cw"></i>
            </button>
            <button id="torch-btn" class="control-btn" onclick="toggleTorch()" style="display:none;">
                <i data-lucide="flashlight"></i>
            </button>
        </div>
    </div>

    <div id="list" class="content-area">
        <div
            style="padding:15px; display:flex; gap:10px; background:white; position:sticky; top:0; z-index:10; border-bottom:1px solid var(--light-grey);">
            <button class="btn btn-dark" style="flex:1" onclick="exportToExcel()">
                <i data-lucide="download" style="width:16px"></i> Mentés
            </button>
            <button class="btn btn-outline" onclick="askClearAll()">
                <i data-lucide="trash-2" style="width:16px; color:var(--danger)"></i>
            </button>
        </div>
        <div id="inventory-container"></div>
    </div>

    <div id="settings" class="content-area" style="padding: 25px;">
        <h3>Beállítások</h3>
        <div style="background: var(--light-grey); padding: 20px; border-radius: 16px;">
            <div style="display:flex; justify-content:space-between; margin-bottom:15px;">
                <label style="font-weight:600;">Kamera Zoom</label>
                <b id="zoom-label">2.0x</b>
            </div>
            <input type="range" id="zoom-slider" min="1" max="5" step="0.1" value="2.0"
                style="width:100%; accent-color:var(--dark);" oninput="applyZoom(this.value)">
        </div>
    </div>

    <div id="backdrop" onclick="closeDrawer(false)"></div>
<div id="drawer">
    <div class="drawer-handle"></div>
    <div style="text-align: center;">
        <div id="drawer-code">---</div>
        <div id="drawer-info">Készleten: 0 db</div>
        
        <div class="qty-selector-container">
            <div class="qty-ribbon" id="qty-ribbon">
                </div>
        </div>



<div class="picker-container">
    <div class="picker-selection-frame"></div>
    <div class="picker-wheel" id="picker-wheel" onscroll="handlePickerScroll()">
        </div>
</div>

<input type="number" id="drawer-qty" style="display:none;" value="1">


        <button class="btn-ok-large" onclick="addFromDrawer(document.getElementById('drawer-qty').value)">Hozzáadás</button>
        <button class="btn" style="color: var(--grey); background:none; margin-top:15px; width:100%;" onclick="closeDrawer(false)">Mégse</button>
    </div>
</div>

    <script>
        let html5QrCode;
        let videoTrack;
        let inventoryData = {};
        let isScanningPaused = false;
        let lastScannedCode = "";
        let audioCtx;
        let autoCloseTimeout = null;

        const quickValues = [1, 2, 3, 4, 5, 10, 12, 20, 24, 50, 100];

        function showTab(tabId, btn) {
            document.querySelectorAll('.content-area').forEach(el => el.classList.remove('active'));
            document.querySelectorAll('.tab-btn').forEach(el => el.classList.remove('active'));
            document.getElementById(tabId).classList.add('active');
            btn.classList.add('active');
            closeDrawer(false);
            if (tabId === 'list') updateUI();
        }

        function initCam() {
            if (html5QrCode) {
                html5QrCode.stop().then(() => startCam()).catch(() => startCam());
            } else {
                startCam();
            }
        }

        function startCam() {
            html5QrCode = new Html5Qrcode("reader");
            const config = { fps: 25, qrbox: { width: 260, height: 160 }, aspectRatio: 1.0 };

            html5QrCode.start({ facingMode: "environment" }, config, onScanSuccess)
                .then(() => setupExtras())
                .catch(err => console.error("Kamera hiba:", err));
        }

        function restartCamera() {
            const btn = document.getElementById('restart-cam-btn');
            // Forgatás animáció
            btn.style.transform = "rotate(180deg)";

            // Vaku gomb azonnali alaphelyzetbe állítása (vizuálisan is)
            const torchBtn = document.getElementById("torch-btn");
            torchBtn.classList.remove('active');

            initCam();
            setTimeout(() => { btn.style.transform = "rotate(0deg)"; }, 500);
        }

        function setupExtras() {
            const video = document.querySelector("#reader video");
            if (video && video.srcObject) {
                videoTrack = video.srcObject.getVideoTracks()[0];
                const caps = videoTrack.getCapabilities();

                // Kényszerítjük a gombot, hogy kövesse a hardver állapotát (ami új indításnál OFF)
                const torchBtn = document.getElementById("torch-btn");
                torchBtn.classList.remove('active');

                const savedZoom = localStorage.getItem("app_zoom") || 2.0;
                applyZoom(savedZoom);
                document.getElementById("zoom-slider").value = savedZoom;

                // Csak akkor mutatjuk a gombot, ha a hardver támogatja
                if (caps.torch) {
                    torchBtn.style.display = "flex";
                } else {
                    torchBtn.style.display = "none";
                }
            }
        }

        function toggleTorch() {
            if (videoTrack) {
                const settings = videoTrack.getSettings();
                const newState = !settings.torch;
                videoTrack.applyConstraints({ advanced: [{ torch: newState }] })
                    .then(() => {
                        document.getElementById('torch-btn').classList.toggle('active', newState);
                    });
            }
        }

        function onScanSuccess(code) {
    if (isScanningPaused) return;

    //resetRibbon();
    resetPicker();

    isScanningPaused = true;
    lastScannedCode = code;
    
    // Alap hangjelzés minden szkennelésnél
    playBeep();

    const isDuplicate = !!inventoryData[code];
    const drawer = document.getElementById('drawer');
    const drawerCode = document.getElementById('drawer-code');

    // Előző állapot törlése
    drawer.classList.remove('duplicate-active');
    
    if (isDuplicate) {
        // DUPLIKÁCIÓ: Dupla rezgés + Sárga jelzés
        if (navigator.vibrate) navigator.vibrate([100, 50, 100]); 
        
        drawer.classList.add('duplicate-active');
        drawerCode.innerHTML = `${code} <span class="duplicate-text">⚠️ MÁR SZEREPEL A LISTÁN</span>`;
    } else {
        // ÚJ TÉTEL: Egy rövid rezgés
        if (navigator.vibrate) navigator.vibrate(60); 
        
        drawerCode.innerText = code;
    }

    // Adatok betöltése a felugró ablakba
    document.getElementById('drawer-info').innerText = "Készleten: " + (inventoryData[code] || 0) + " db";
    document.getElementById('drawer-qty').value = 1;
    
    // Ablak megjelenítése
    drawer.classList.add('open');
    document.getElementById('backdrop').classList.add('active');
    
    // Automatikus hozzáadás indítása (3 mp múlva lezár)
    startAutoClose();
}

/*function onScanSuccess(code) {
    if (isScanningPaused) return;
    isScanningPaused = true;
    lastScannedCode = code;
    playBeep();

    const isDuplicate = !!inventoryData[code]; // Ellenőrizzük, létezik-e már
    const drawer = document.getElementById('drawer');
    const drawerCode = document.getElementById('drawer-code');

    // Reseteljük az előző állapotot
    drawer.classList.remove('duplicate-active');
    
    if (isDuplicate) {
        // Ha duplikáció van: vizuális jelzés
        drawer.classList.add('duplicate-active');
        drawerCode.innerHTML = `${code} <span class="duplicate-text">⚠️ MÁR SZEREPEL A LISTÁN</span>`;
        navigator.vibrate?.([100, 50, 100]); // Kettős rezgés jelzés (ha a mobil támogatja)
    } else {
        drawerCode.innerText = code;
    }

    document.getElementById('drawer-info').innerText = "Készleten: " + (inventoryData[code] || 0) + " db";
    document.getElementById('drawer-qty').value = 1;
    drawer.classList.add('open');
    document.getElementById('backdrop').classList.add('active');
    startAutoClose();
}*/

        function startAutoClose() {
            cancelAutoClose();
            autoCloseTimeout = setTimeout(() => {
                addFromDrawer(document.getElementById('drawer-qty').value);
            }, 3000);
        }

        function cancelAutoClose() {
            if (autoCloseTimeout) { clearTimeout(autoCloseTimeout); autoCloseTimeout = null; }
        }

        function closeDrawer(save = true) {
            cancelAutoClose();
            document.getElementById('drawer').classList.remove('open');
            document.getElementById('backdrop').classList.remove('active');
            setTimeout(() => { isScanningPaused = false; }, 400);
        }

        // Módosítani kell a hozzáadás gombot is, hogy az egyéni mezőt is figyelje
function addFromDrawer() {
    const finalQty = parseInt(document.getElementById('drawer-qty').value);

    if (!isNaN(finalQty) && finalQty > 0) {
        inventoryData[lastScannedCode] = (inventoryData[lastScannedCode] || 0) + finalQty;
        saveData();
        closeDrawer(true);
    } else {
        alert("Kérlek adj meg egy érvényes számot!");
    }
}

        function updateUI() {
            const container = document.getElementById('inventory-container');
            container.innerHTML = "";
            const keys = Object.keys(inventoryData).reverse();
            if (keys.length === 0) {
                container.innerHTML = "<div style='text-align:center; color:#bbb; margin-top:80px;'><i data-lucide='package-open' style='width:48px; height:48px; opacity:0.3'></i><p>A lista üres</p></div>";
                lucide.createIcons();
                return;
            }
            keys.forEach(code => {
                const card = document.createElement('div');
                card.className = 'item-card';
                card.innerHTML = `
                    <div>
                        <div style="font-size:14px; font-weight:700; color:var(--dark);">${code}</div>
                        <div style="color:var(--primary); font-weight:700; font-size:13px; margin-top:2px;">${inventoryData[code]} db</div>
                    </div>
                    <div class="qty-controls">
                        <button class="btn btn-outline btn-qty" onclick="modQty('${code}', -1)"><i data-lucide="minus" style="width:16px"></i></button>
                        <button class="btn btn-outline btn-qty" onclick="modQty('${code}', 1)"><i data-lucide="plus" style="width:16px"></i></button>
                        <button class="btn btn-outline btn-qty" style="margin-left:8px;" onclick="delItem('${code}')"><i data-lucide="trash-2" style="width:16px; color:var(--danger)"></i></button>
                    </div>`;
                container.appendChild(card);
            });
            lucide.createIcons();
        }

        function modQty(c, v) { inventoryData[c] += v; if (inventoryData[c] <= 0) delete inventoryData[c]; updateUI(); saveData(); }
        function delItem(c) { if (confirm("Törli az elemet?")) { delete inventoryData[c]; updateUI(); saveData(); } }
        function askClearAll() { if (confirm("Biztosan törli az összes adatot?")) { inventoryData = {}; updateUI(); saveData(); } }

        function applyZoom(v) {
            if (videoTrack) {
                videoTrack.applyConstraints({ advanced: [{ zoom: parseFloat(v) }] });
                document.getElementById("zoom-label").innerText = parseFloat(v).toFixed(1) + "x";
                localStorage.setItem("app_zoom", v);
            }
        }

        function playBeep() {
            if (!audioCtx) audioCtx = new (window.AudioContext || window.webkitAudioContext)();
            const osc = audioCtx.createOscillator();
            const g = audioCtx.createGain();
            osc.connect(g); g.connect(audioCtx.destination);
            osc.frequency.value = 800; g.gain.value = 0.05;
            osc.start(); osc.stop(audioCtx.currentTime + 0.1);
        }


function exportToExcel() {
    // Ellenőrizzük, van-e adat
    if (Object.keys(inventoryData).length === 0) {
        alert("Nincs menthető adat a listában!");
        return;
    }

    // 1. Időbélyegek előkészítése
    const now = new Date();
    const dateStr = now.toISOString().slice(0, 10); 
    const fullDateStr = now.toLocaleString('hu-HU');

    // 2. Megjegyzés bekérése
    let comment = prompt("Add meg a fájlhoz fűzött megjegyzést (pl. 'Raktár A'):", "");
    let displayComment = (comment && comment.trim() !== "") ? comment.trim() : "Nincs megjegyzés";

    // 3. Fájlnév összeállítása
    let fileName = `leltar_${dateStr}`;
    if (comment && comment.trim() !== "") {
        const safeComment = comment.trim().replace(/[^a-z0-9áéíóöőúüű\-_]/gi, '_');
        fileName += `_${safeComment}`;
    }

    // 4. Excel tartalom összeállítása
    const headerInfo = [
        ["LELTÁR JELENTÉS"],
        ["Dátum:", fullDateStr],
        ["Megjegyzés:", displayComment],
        [""] 
    ];

    const ws = XLSX.utils.aoa_to_sheet(headerInfo);

    const tableData = Object.keys(inventoryData).map(k => ({
        "Vonalkód": k,
        "Mennyiség (db)": inventoryData[k]
    }));

    XLSX.utils.sheet_add_json(ws, tableData, { origin: "A5" });

    // 5. Mentés folyamata
    const wb = XLSX.utils.book_new();
    XLSX.utils.book_append_sheet(wb, ws, "Leltár");
    
    try {
        XLSX.writeFile(wb, `${fileName}.xlsx`);
        
        // --- ADATTÖRLÉS A MENTÉS UTÁN ---
        // Csak akkor törlünk, ha a mentési parancs lefutott
        inventoryData = {}; // Adatok ürítése a memóriából
        saveData();        // Üres állapot mentése a telefon tárhelyére
        updateUI();        // Lista frissítése a képernyőn (üres lesz)
        
        alert("Sikeres mentés! A lista automatikusan törlődött.");
    } catch (e) {
        alert("Hiba történt a mentés során! Az adatok megmaradtak.");
        console.error(e);
    }
}



function renderQtyRibbon() {
    const container = document.querySelector('.qty-selector-container');
    const ribbon = document.getElementById('qty-ribbon');
    
    // Ha a felhasználó elkezd görgetni, azonnal állítsuk le az automata bezárást
    container.onscroll = () => {
        cancelAutoClose();
    };

    // Ez megakadályozza, hogy a görgetés "beragadjon"
    container.ontouchstart = () => {
        cancelAutoClose();
    };

    ribbon.innerHTML = "";
    quickValues.forEach(val => {
        const chip = document.createElement('div');
        chip.className = `qty-chip ${val === 1 ? 'selected' : ''}`;
        chip.innerText = val;
        chip.onclick = () => selectQty(val, chip);
        ribbon.appendChild(chip);
    });
}

function selectQty(val, element) {
    document.getElementById('drawer-qty').value = val;
    // Kijelölés vizuális frissítése
    document.querySelectorAll('.qty-chip').forEach(c => c.classList.remove('selected'));
    element.classList.add('selected');
    
    // Görgetés az elemhez, hogy középen legyen
    element.scrollIntoView({ behavior: 'smooth', block: 'nearest', inline: 'center' });
    
    // Ha kézzel választanak, ne záródjon be az ablak automatikusan
    cancelAutoClose();
}

function resetRibbon() {
    const container = document.querySelector('.qty-selector-container');
    document.getElementById('drawer-qty').value = 1;
    
    const chips = document.querySelectorAll('.qty-chip');
    chips.forEach(c => {
        c.classList.remove('selected');
        if(c.innerText == "1") {
            c.classList.add('selected');
        }
    });

    // Visszatekerjük az elejére simán
    container.scrollTo({ left: 0, behavior: 'smooth' });
}







function renderQtyPicker() {
    const wheel = document.getElementById('picker-wheel');
    wheel.innerHTML = "";

    // 1. Létrehozzuk az "Egyéni" beviteli mezőt legfelülre
    const manualItem = document.createElement('div');
    manualItem.className = 'picker-item';
    manualItem.innerHTML = `<input type="number" id="manual-qty" placeholder="Egyéni..." onfocus="cancelAutoClose()">`;
    manualItem.setAttribute('data-val', 'manual');
    wheel.appendChild(manualItem);

    // 2. Létrehozzuk a fix számokat
    quickValues.forEach(val => {
        const item = document.createElement('div');
        item.className = 'picker-item';
        item.innerText = val;
        item.setAttribute('data-val', val);
        wheel.appendChild(item);
    });
}

function handlePickerScroll() {
    cancelAutoClose();
    const wheel = document.getElementById('picker-wheel');
    const items = wheel.querySelectorAll('.picker-item');
    const wheelCenter = wheel.scrollTop + (wheel.clientHeight / 2);
    const manualInput = document.getElementById('manual-qty');

    items.forEach(item => {
        const itemCenter = item.offsetTop + (item.clientHeight / 2);
        const distance = Math.abs(wheelCenter - itemCenter);

        if (distance < 25) {
            // Ha már van aktív, és az nem a mostani, akkor levesszük
            items.forEach(i => i.classList.remove('active'));
            item.classList.add('active');
            
            const currentVal = item.getAttribute('data-val');
            
            if (currentVal === "manual") {
                // Ha az egyéni mezőre értünk
                document.getElementById('drawer-qty').value = manualInput.value;
                manualInput.oninput = () => {
                    document.getElementById('drawer-qty').value = manualInput.value;
                };
            } else {
                // Ha elgörgetünk a manual-ról, vegyük le róla a fókuszt (billentyűzet elrejtése)
                if (document.activeElement === manualInput) {
                    manualInput.blur();
                }
                document.getElementById('drawer-qty').value = currentVal;
            }
        }
    });
}

function resetPicker() {
    const wheel = document.getElementById('picker-wheel');
    const manualInput = document.getElementById('manual-qty');
    
    // Alaphelyzet: az 1-es számra görgetünk (ez a 2. elem, 50px-nél)
    wheel.scrollTo({ top: 50, behavior: 'instant' }); 
    if (manualInput) manualInput.value = ""; 
    document.getElementById('drawer-qty').value = 1;
    handlePickerScroll();
}



        window.onload = () => {
            lucide.createIcons();
            loadData();
            initCam();
            //renderQtyRibbon();
            renderQtyPicker();
        };
    </script>
</body>

</html>