<!DOCTYPE html>
<html lang="hu">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Super-Pro Lelt√°r</title>
    <script src="https://unpkg.com/html5-qrcode" type="text/javascript"></script>
    
    <style>
        body { font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; text-align: center; background: #f0f2f5; margin: 0; padding: 10px; padding-bottom: 50px; }
        
        h2 { color: #333; margin-bottom: 10px; margin-top: 5px; }

        /* --- KAMERA --- */
        #reader {
            width: 100%;
            max-width: 500px;
            margin: 0 auto 10px auto;
            border-radius: 12px;
            overflow: hidden;
            background: #000;
            box-shadow: 0 4px 10px rgba(0,0,0,0.2);
        }

        /* --- VEZ√âRL≈ê PULT --- */
        .controls { 
            background: white; 
            padding: 15px; 
            border-radius: 10px; 
            max-width: 500px; 
            margin: 0 auto 20px auto; 
            box-shadow: 0 2px 5px rgba(0,0,0,0.1);
        }

        /* K√©zi bevitel doboz */
        .manual-input-group {
            display: flex;
            gap: 5px;
            margin-bottom: 15px;
        }
        .manual-input-group input {
            flex: 1;
            padding: 10px;
            border: 2px solid #ddd;
            border-radius: 5px;
            font-size: 16px;
        }
        .manual-input-group button {
            background-color: #2a9d8f;
            width: auto;
        }

        /* T√∂meges kapcsol√≥ */
        .bulk-toggle-container {
            display: flex;
            align-items: center;
            justify-content: center;
            margin-bottom: 15px;
            padding: 10px;
            background: #eee;
            border-radius: 8px;
        }
        .bulk-toggle-container input { margin-right: 10px; transform: scale(1.5); }
        .bulk-label { font-weight: bold; color: #555; }
        .bulk-active { background-color: #ffe8d6; border: 1px solid #e76f51; color: #e76f51; }

        /* Zoom */
        #zoom-container { display: none; width: 95%; margin: 0 auto 15px auto; }
        input[type=range] { width: 100%; cursor: pointer; }
        label { font-size: 14px; font-weight: bold; color: #555; }

        /* Als√≥ gombok */
        .btn-group { display: flex; justify-content: center; gap: 8px; flex-wrap: wrap; }
        
        button { padding: 10px 15px; border: none; border-radius: 5px; cursor: pointer; color: white; font-weight: bold; font-size: 14px; width: 100%; }
        #clear-btn { background-color: #e76f51; flex: 1; }
        #export-btn { background-color: #264653; flex: 1; }
        #torch-btn { background-color: #e9c46a; color: #333; display: none; flex: 1; }

        /* --- T√ÅBL√ÅZAT --- */
        .table-container {
            width: 100%;
            max-width: 600px;
            margin: 0 auto;
            overflow-x: auto;
            background: white;
            border-radius: 8px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
        }
        table { width: 100%; border-collapse: collapse; }
        th, td { padding: 10px; text-align: left; border-bottom: 1px solid #ddd; vertical-align: middle; }
        th { background-color: #2a9d8f; color: white; text-transform: uppercase; font-size: 0.85rem; }
        tr:nth-child(even) { background-color: #f9f9f9; }
        
        .highlight { background-color: #d4edda !important; transition: background-color 1s ease; }
        
        .code-col { font-family: monospace; font-size: 1.1rem; color: #333; }
        .qty-col { font-weight: bold; color: #264653; font-size: 1.2rem; text-align: center; width: 50px; }
        
        /* Akci√≥ gombok a t√°bl√°zatban */
        .action-col { text-align: right; white-space: nowrap; width: 80px; }
        .btn-mini { 
            padding: 5px 10px; 
            margin-left: 3px; 
            font-size: 14px; 
            width: auto; 
            display: inline-block; 
        }
        .btn-minus { background-color: #6c757d; } /* Sz√ºrke */
        .btn-delete { background-color: #d62828; } /* Piros */

    </style>
</head>
<body>

    <h2>üöÄ Super-Pro Lelt√°r</h2>
    
    <div id="reader"></div>

    <div class="controls">
        
        <div class="manual-input-group">
            <input type="number" id="manual-input" placeholder="K√©zi k√≥d (pl. 599...)" onkeydown="checkEnter(event)">
            <button onclick="addManualCode()">+ Hozz√°ad</button>
        </div>

        <div id="zoom-container">
            <label for="zoom-slider">üîç Nagy√≠t√°s:</label>
            <input type="range" id="zoom-slider" min="1" max="5" step="0.1" value="1" oninput="applyZoom(this.value)">
        </div>

        <div class="bulk-toggle-container" id="bulk-box">
            <input type="checkbox" id="bulk-mode" onchange="toggleBulkUI()">
            <label for="bulk-mode" class="bulk-label">üì¶ T√∂meges m√≥d (Mennyis√©g k√©r√©se)</label>
        </div>

        <div class="btn-group">
            <button id="torch-btn" onclick="toggleTorch()">üî¶ L√°mpa</button>
            <button id="clear-btn" onclick="clearData()">üóëÔ∏è T√∂rl√©s</button>
            <button id="export-btn" onclick="exportToCSV()">üíæ Excel</button>
        </div>
    </div>

    <div class="table-container">
        <table id="inventory-table">
            <thead>
                <tr>
                    <th>K√≥d</th>
                    <th class="qty-col">Db</th>
                    <th class="action-col">Jav√≠t√°s</th>
                </tr>
            </thead>
            <tbody id="table-body"></tbody>
        </table>
    </div>

    <script>
        let html5QrCode;
        let isTorchOn = false;
        let videoTrack; 
        let inventoryData = {}; 
        let audioCtx;

        // --- HANG ---
        function playBeep() {
            if (!audioCtx) audioCtx = new (window.AudioContext || window.webkitAudioContext)();
            if (audioCtx.state === 'suspended') audioCtx.resume();

            const oscillator = audioCtx.createOscillator();
            const gainNode = audioCtx.createGain();

            oscillator.connect(gainNode);
            gainNode.connect(audioCtx.destination);

            oscillator.type = 'square'; 
            oscillator.frequency.value = 800; 
            gainNode.gain.value = 0.1; 

            oscillator.start();
            setTimeout(() => { oscillator.stop(); }, 150); 
        }
        
        // Hang aktiv√°l√°sa els≈ë kattint√°sra (iPhone miatt)
        document.body.addEventListener('click', () => {
            if (!audioCtx) audioCtx = new (window.AudioContext || window.webkitAudioContext)();
            if (audioCtx.state === 'suspended') audioCtx.resume();
        }, { once: true });


        // --- KAMERA IND√çT√ÅS ---
        function startScanner() {
            html5QrCode = new Html5Qrcode("reader");

            const config = { 
                fps: 10, 
                qrbox: { width: 250, height: 250 },
                aspectRatio: 1.0,
                videoConstraints: {
                    facingMode: "environment",
                    width: { min: 640, ideal: 1280, max: 1920 }, 
                    height: { min: 480, ideal: 720, max: 1080 },
                    focusMode: "continuous"
                }
            };
            
            html5QrCode.start({ facingMode: "environment" }, config, onScanSuccess)
            .then(() => { setupCameraControls(); })
            .catch(err => { alert("Kamera hiba: " + err); });
        }

        // --- BEOLVAS√ÅS LOGIKA (IT T√ñRT√âNT A VAR√ÅZSLAT) ---
        function onScanSuccess(decodedText) {
            const code = decodedText.trim();
            if(code === "") return;

            // Visszajelz√©sek
            if (navigator.vibrate) navigator.vibrate(200); 
            playBeep();

            // 4. T√ñMEGES M√ìD ELLEN≈êRZ√âSE
            const isBulk = document.getElementById("bulk-mode").checked;
            let qtyToAdd = 1;

            if (isBulk) {
                // Kamera sz√ºnetel, am√≠g be√≠rod a sz√°mot
                html5QrCode.pause(); 
                let inputQty = prompt(`"${code}" beolvasva.\nMennyi van ebb≈ël?`, "1");
                
                if (inputQty === null) {
                    // Ha a 'M√©gse' gombra nyomsz
                    html5QrCode.resume();
                    return; 
                }

                qtyToAdd = parseInt(inputQty);
                if (isNaN(qtyToAdd) || qtyToAdd <= 0) {
                    alert("Hib√°s sz√°m! Csak 1 darabot adok hozz√°.");
                    qtyToAdd = 1;
                }
                html5QrCode.resume();
            }

            // Adatok ment√©se
            addQuantity(code, qtyToAdd);
            
            // Sz√ºnet, ha nem t√∂meges m√≥dban vagyunk (hogy ne p√∂r√∂gj√∂n)
            if (!isBulk) {
                html5QrCode.pause();
                setTimeout(() => { html5QrCode.resume(); }, 1000);
            }
        }

        // --- 1. K√âZI HOZZ√ÅAD√ÅS ---
        function addManualCode() {
            const input = document.getElementById("manual-input");
            const code = input.value.trim();
            
            if (code) {
                // Ugyanazt a logik√°t h√≠vjuk meg, mintha a kamera l√°tta volna
                onScanSuccess(code); 
                input.value = ""; // Mez≈ë t√∂rl√©se
                input.focus();
            } else {
                alert("√çrj be egy k√≥dot!");
            }
        }

        function checkEnter(event) {
            if (event.key === "Enter") {
                addManualCode();
            }
        }

        // --- ADATKEZEL√âS K√ñZPONTI F√úGGV√âNYE ---
        function addQuantity(code, amount) {
            if (inventoryData[code]) {
                inventoryData[code] += amount;
            } else {
                inventoryData[code] = amount;
            }
            updateTable(code);
        }

        // --- 2. JAV√çT√ÅS (M√çNUSZOL√ÅS / T√ñRL√âS) ---
        function modifyQty(code, change) {
            if (inventoryData[code]) {
                inventoryData[code] += change;
                if (inventoryData[code] <= 0) {
                    delete inventoryData[code]; // Ha 0 vagy kevesebb, t√∂r√∂lj√ºk
                }
                updateTable(null); // Itt nem kell highlight
            }
        }

        function deleteRow(code) {
            if (confirm("Biztosan t√∂rl√∂d a(z) " + code + " sort?")) {
                delete inventoryData[code];
                updateTable(null);
            }
        }

        // --- T√ÅBL√ÅZAT FRISS√çT√âS ---
        function updateTable(highlightCode) {
            const tbody = document.getElementById("table-body");
            tbody.innerHTML = ""; 
            
            // Ford√≠tott sorrend (leg√∫jabb fel√ºl)
            Object.keys(inventoryData).reverse().forEach(code => {
                const qty = inventoryData[code];
                const row = document.createElement("tr");
                
                if (code === highlightCode) {
                    row.classList.add("highlight");
                    row.scrollIntoView({ behavior: 'smooth', block: 'center' });
                }

                // Itt hozzuk l√©tre a gombokat a t√°bl√°zatban
                row.innerHTML = `
                    <td class="code-col">${code}</td>
                    <td class="qty-col">${qty}</td>
                    <td class="action-col">
                        <button class="btn-mini btn-minus" onclick="modifyQty('${code}', -1)">‚ûñ</button>
                        <button class="btn-mini btn-delete" onclick="deleteRow('${code}')">‚ùå</button>
                    </td>
                `;
                tbody.appendChild(row); 
            });
        }

        // --- UI Extr√°k ---
        function toggleBulkUI() {
            const checkbox = document.getElementById("bulk-mode");
            const container = document.getElementById("bulk-box");
            if (checkbox.checked) {
                container.classList.add("bulk-active");
            } else {
                container.classList.remove("bulk-active");
            }
        }

        function clearData() {
            if (confirm("Minden adat t√∂rl≈ëdik!")) {
                inventoryData = {};
                updateTable();
            }
        }

        function exportToCSV() {
            let csvContent = "data:text/csv;charset=utf-8,Vonalkod,Darabszam\n";
            Object.keys(inventoryData).forEach(code => {
                csvContent += `${code},${inventoryData[code]}\n`;
            });
            const encodedUri = encodeURI(csvContent);
            const link = document.createElement("a");
            link.setAttribute("href", encodedUri);
            link.setAttribute("download", "leltar_pro.csv");
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
        }

        // --- KAMERA EXTR√ÅK (ZOOM, VAKU) ---
        function setupCameraControls() {
            setTimeout(() => {
                const videoElement = document.querySelector("#reader video");
                if (videoElement && videoElement.srcObject) {
                    const stream = videoElement.srcObject;
                    videoTrack = stream.getVideoTracks()[0];
                    const capabilities = videoTrack.getCapabilities();
                    const settings = videoTrack.getSettings();

                    if (capabilities.zoom) {
                        const zoomContainer = document.getElementById("zoom-container");
                        const zoomSlider = document.getElementById("zoom-slider");
                        zoomContainer.style.display = "block";
                        zoomSlider.min = capabilities.zoom.min;
                        zoomSlider.max = capabilities.zoom.max;
                        zoomSlider.step = capabilities.zoom.step;
                        zoomSlider.value = settings.zoom || 1;
                    }
                    if (capabilities.torch) {
                        document.getElementById("torch-btn").style.display = "inline-block";
                    }
                }
            }, 500);
        }

        function applyZoom(value) {
            if (videoTrack) {
                videoTrack.applyConstraints({ advanced: [{ zoom: parseFloat(value) }] })
                .catch(e => console.log(e));
            }
        }

        function toggleTorch() {
            if (!videoTrack) return;
            isTorchOn = !isTorchOn;
            videoTrack.applyConstraints({ advanced: [{ torch: isTorchOn }] })
            .catch(e => console.log(e));
        }

        window.onload = startScanner;
    </script>
</body>
</html>