<!DOCTYPE html>
<html lang="hu">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>PRO Lelt√°r</title>
    <link rel="icon" type="image/png" href="logo.png">
    
    <script src="https://unpkg.com/html5-qrcode" type="text/javascript"></script>
    <script src="https://cdn.sheetjs.com/xlsx-0.20.1/package/dist/xlsx.full.min.js"></script>
    
    <style>
        :root {
            --primary: #2a9d8f;
            --secondary: #264653;
            --danger: #e76f51;
            --warning: #e9c46a;
            --bg: #f8f9fa;
            --card: #ffffff;
        }

        body { 
            font-family: 'Segoe UI', system-ui, -apple-system, sans-serif; 
            text-align: center; 
            background: var(--bg); 
            margin: 0; 
            padding: 8px;
            color: #333;
        }
        
        h2 { font-size: 1.1rem; margin: 5px 0; color: var(--secondary); display: flex; align-items: center; justify-content: center; gap: 8px; }

        /* KAMERA KONTEXTUS */
        #reader-container {
            position: relative;
            width: 100%;
            max-width: 450px;
            margin: 0 auto 10px auto;
            border-radius: 12px;
            overflow: hidden;
            box-shadow: 0 4px 12px rgba(0,0,0,0.15);
            background: #000;
        }
        #reader { width: 100%; height: 200px; }
        
        /* Szkennel√©si sz√ºnet vizu√°lis jelz√©se */
        #scan-overlay {
            position: absolute; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(42, 157, 143, 0.4);
            display: none; align-items: center; justify-content: center;
            color: white; font-weight: bold; font-size: 1.2rem; z-index: 10;
        }

        /* VEZ√âRL≈êPANEL */
        .main-card { 
            background: var(--card); 
            padding: 12px; 
            border-radius: 12px; 
            max-width: 450px; 
            margin: 0 auto 10px auto; 
            box-shadow: 0 2px 8px rgba(0,0,0,0.05);
        }

        .input-row { display: flex; gap: 6px; margin-bottom: 8px; }
        input { 
            padding: 10px; border: 1px solid #ddd; border-radius: 6px; 
            font-size: 14px; outline: none; transition: border 0.2s;
        }
        input:focus { border-color: var(--primary); }
        #manual-input { flex: 1; }
        #search-input { width: 100%; box-sizing: border-box; background: #f0f0f0; border: none; margin-bottom: 8px; }

        button { 
            border: none; border-radius: 6px; cursor: pointer; 
            color: white; font-weight: 600; font-size: 14px;
            transition: opacity 0.2s, transform 0.1s;
            display: flex; align-items: center; justify-content: center;
        }
        button:active { transform: scale(0.96); }
        .btn-add { background: var(--primary); padding: 0 20px; }

        .btn-grid { display: grid; grid-template-columns: repeat(4, 1fr); gap: 6px; }
        .btn-grid button { padding: 12px 0; font-size: 18px; }
        
        #clear-btn { background: var(--danger); }
        #export-btn { background: var(--secondary); }
        #torch-btn { background: var(--warning); color: #333; }
        #cam-restart-btn { background: #457b9d; }

        /* Zoom & Bulk */
        .settings-row { 
            display: flex; justify-content: space-between; align-items: center; 
            margin-top: 10px; font-size: 0.85rem; background: #f9f9f9; padding: 6px; border-radius: 6px;
        }
        .bulk-toggle { display: flex; align-items: center; gap: 5px; cursor: pointer; font-weight: bold; }
        .bulk-toggle input { transform: scale(1.2); margin: 0; }
        
        #zoom-slider { flex: 1; margin: 0 10px; height: 4px; }

        /* T√ÅBL√ÅZAT */
        .table-wrapper { 
            max-width: 500px; margin: 0 auto; background: white; 
            border-radius: 8px; overflow: hidden; box-shadow: 0 2px 8px rgba(0,0,0,0.05);
        }
        .scroll-area { max-height: 40vh; overflow-y: auto; }
        table { width: 100%; border-collapse: collapse; font-size: 0.9rem; }
        thead { position: sticky; top: 0; background: var(--primary); color: white; z-index: 5; }
        th, td { padding: 10px 8px; text-align: left; border-bottom: 1px solid #eee; }
        
        .qty-cell { font-weight: bold; text-align: center; width: 50px; }
        .actions { text-align: right; white-space: nowrap; width: 110px; }

        .btn-circle {
            width: 30px; height: 30px; border-radius: 50%; display: inline-flex;
            margin-left: 3px; font-size: 16px;
        }

        /* MODAL */
        #overlay {
            display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(0,0,0,0.7); z-index: 100; align-items: center; justify-content: center;
            backdrop-filter: blur(3px);
        }
        .modal { background: white; padding: 20px; border-radius: 12px; width: 80%; max-width: 300px; }
        #modal-qty { width: 100%; font-size: 1.5rem; text-align: center; margin: 15px 0; border: 2px solid var(--primary); }

        .highlight-row { background-color: #e9f5f2 !important; animation: flash 1.5s; }
        @keyframes flash { from { background-color: var(--primary); color: white; } to { background-color: #e9f5f2; } }
    </style>
</head>
<body>

    <h2>üì¶ PRO LELT√ÅR</h2>
    
    <div id="reader-container">
        <div id="reader"></div>
        <div id="scan-overlay">BEOLVASVA!</div>
    </div>

    <div class="main-card">
        <div class="input-row">
            <input type="number" id="manual-input" placeholder="Vonalk√≥d manu√°lisan..." onkeydown="if(event.key==='Enter') addManualCode()">
            <button class="btn-add" onclick="addManualCode()">OK</button>
        </div>

        <input type="text" id="search-input" placeholder="üîç Keres√©s a list√°ban..." oninput="filterTable()">

        <div class="btn-grid">
            <button id="cam-restart-btn" title="Kamera √∫jrat√∂lt√©se" onclick="playClick(); restartCamera()">üì∑</button>
            <button id="torch-btn" title="Zsebl√°mpa" onclick="playClick(); toggleTorch()">üî¶</button>
            <button id="clear-btn" title="√ñsszes t√∂rl√©se" onclick="playClick(); askClearAll()">üóëÔ∏è</button>
            <button id="export-btn" title="Ment√©s Excelbe" onclick="playClick(); exportToExcel()">üíæ</button>
        </div>

        <div class="settings-row">
            <label class="bulk-toggle">
                <input type="checkbox" id="bulk-mode" onchange="toggleBulkUI()"> T√∂meges
            </label>
            <span style="margin-left:10px">üîç</span>
            <input type="range" id="zoom-slider" min="1" max="5" step="0.1" value="1" oninput="applyZoom(this.value)">
        </div>
    </div>

    <div class="table-wrapper">
        <table>
            <thead>
                <tr>
                    <th>K√≥d</th>
                    <th class="qty-cell">Db</th>
                    <th class="actions">M≈±velet</th>
                </tr>
            </thead>
        </table>
        <div class="scroll-area">
            <table>
                <tbody id="table-body"></tbody>
            </table>
        </div>
    </div>

    <div id="overlay">
        <div class="modal">
            <div id="modal-text" style="font-weight:bold; margin-bottom:10px;">√úzenet</div>
            <input type="number" id="modal-qty" value="1">
            <div style="display:flex; gap:10px;">
                <button onclick="closeModal(false)" style="background:#888; flex:1; padding:10px;">M√©gse</button>
                <button id="modal-confirm-btn" onclick="closeModal(true)" style="background:var(--primary); flex:1; padding:10px;">OK</button>
            </div>
        </div>
    </div>

    <script>
        let html5QrCode;
        let videoTrack;
        let inventoryData = {};
        let isScanningPaused = false;
        let currentAction = null;
        let tempCode = "";

        // --- HANG √âS REZG√âS ---
        function feedback() {
            // Hang
            try {
                const audioCtx = new (window.AudioContext || window.webkitAudioContext)();
                const osc = audioCtx.createOscillator();
                const gain = audioCtx.createGain();
                osc.connect(gain); gain.connect(audioCtx.destination);
                osc.type = 'square'; osc.frequency.value = 600; gain.gain.value = 0.1;
                osc.start(); osc.stop(audioCtx.currentTime + 0.1);
            } catch(e) {}
            // Rezg√©s
            if (navigator.vibrate) navigator.vibrate(80);
        }

        function playClick() { if (navigator.vibrate) navigator.vibrate(20); }

        // --- ADATKEZEL√âS ---
        function saveData() { localStorage.setItem("inventory_v2", JSON.stringify(inventoryData)); }
        
        function loadData() {
            const saved = localStorage.getItem("inventory_v2");
            if (saved) { inventoryData = JSON.parse(saved); updateTable(); }
            if (localStorage.getItem("bulk_mode") === "true") {
                document.getElementById("bulk-mode").checked = true;
                toggleBulkUI();
            }
        }

        // --- KAMERA ---
        function initCamera() {
            html5QrCode = new Html5Qrcode("reader");
            const config = { fps: 15, qrbox: { width: 250, height: 150 }, aspectRatio: 1.77 };
            
            html5QrCode.start({ facingMode: "environment" }, config, (text) => {
                if (isScanningPaused) return;
                feedback();
                handleScannedCode(text.trim());
            }).then(setupControls).catch(err => console.error(err));
        }

        function handleScannedCode(code) {
            isScanningPaused = true;
            document.getElementById("scan-overlay").style.display = "flex";
            
            if (document.getElementById("bulk-mode").checked) {
                openModal('bulk-add', code);
            } else {
                addQty(code, 1);
                setTimeout(resumeScanning, 1500); // 1.5 mp sz√ºnet k√©t k√≥d k√∂z√∂tt
            }
        }

        function resumeScanning() {
            isScanningPaused = false;
            document.getElementById("scan-overlay").style.display = "none";
        }

        // --- T√ÅBL√ÅZAT √âS KERES√âS ---
        function updateTable(highlightCode = null) {
            const tbody = document.getElementById("table-body");
            tbody.innerHTML = "";
            const keys = Object.keys(inventoryData).reverse();
            
            keys.forEach(code => {
                const row = document.createElement("tr");
                if (code === highlightCode) row.className = "highlight-row";
                
                row.innerHTML = `
                    <td>${code}</td>
                    <td class="qty-cell">${inventoryData[code]}</td>
                    <td class="actions">
                        <button class="btn-circle" style="background:var(--secondary)" onclick="modifyQty('${code}', -1)">-</button>
                        <button class="btn-circle" style="background:var(--primary)" onclick="modifyQty('${code}', 1)">+</button>
                        <button class="btn-circle" style="background:#aaa;" onclick="askDeleteRow('${code}')">√ó</button>
                    </td>
                `;
                tbody.appendChild(row);
            });
            filterTable(); // Keres√©s fenntart√°sa friss√≠t√©skor
        }

        function filterTable() {
            const query = document.getElementById("search-input").value.toLowerCase();
            const rows = document.querySelectorAll("#table-body tr");
            rows.forEach(row => {
                const code = row.cells[0].innerText.toLowerCase();
                row.style.display = code.includes(query) ? "" : "none";
            });
        }

        function addQty(code, amount) {
            inventoryData[code] = (inventoryData[code] || 0) + amount;
            saveData();
            updateTable(code);
        }

        function modifyQty(code, change) {
            playClick();
            inventoryData[code] += change;
            if (inventoryData[code] <= 0) askDeleteRow(code);
            else { saveData(); updateTable(); }
        }

        // --- MODAL RENDSZER ---
        function openModal(action, code = "") {
            currentAction = action;
            tempCode = code;
            const overlay = document.getElementById("overlay");
            const input = document.getElementById("modal-qty");
            const txt = document.getElementById("modal-text");
            
            overlay.style.display = "flex";
            input.style.display = action === 'bulk-add' ? "block" : "none";
            
            if(action === 'bulk-add') {
                txt.innerHTML = `K√≥d: ${code}<br>Mennyis√©g:`;
                input.value = 1;
                input.focus();
            } else if(action === 'clear-all') {
                txt.innerText = "Mindent t√∂r√∂ls soul?";
            } else {
                txt.innerText = `T√∂r√∂lj√ºk? \n ${code}`;
            }
        }

        function closeModal(confirmed) {
            document.getElementById("overlay").style.display = "none";
            if (confirmed) {
                if (currentAction === 'bulk-add') {
                    const q = parseInt(document.getElementById("modal-qty").value);
                    if (q > 0) addQty(tempCode, q);
                } else if (currentAction === 'clear-all') {
                    inventoryData = {}; saveData(); updateTable();
                } else if (currentAction === 'delete-one') {
                    delete inventoryData[tempCode]; saveData(); updateTable();
                }
            }
            resumeScanning();
        }

        // --- EXPORT ---
        function exportToExcel() {
            if (Object.keys(inventoryData).length === 0) return alert("√úres a lista!");
            const exportArr = Object.keys(inventoryData).map(k => ({ "Vonalk√≥d": k, "Darab": inventoryData[k] }));
            const ws = XLSX.utils.json_to_sheet(exportArr);
            const wb = XLSX.utils.book_new();
            XLSX.utils.book_append_sheet(wb, ws, "Lelt√°r");
            
            const now = new Date();
            const dateStr = now.toISOString().split('T')[0];
            const timeStr = now.getHours() + "-" + now.getMinutes();
            XLSX.writeFile(wb, `leltar_${dateStr}_${timeStr}.xlsx`);
        }

        // --- KAMERA EXTR√ÅK ---
        function setupControls() {
            setTimeout(() => {
                const video = document.querySelector("#reader video");
                if (!video || !video.srcObject) return;
                videoTrack = video.srcObject.getVideoTracks()[0];
                const caps = videoTrack.getCapabilities();
                if (caps.zoom) {
                    const zs = document.getElementById("zoom-slider");
                    zs.min = caps.zoom.min; zs.max = caps.zoom.max; zs.step = caps.zoom.step;
                }
                if (caps.torch) document.getElementById("torch-btn").style.display = "flex";
            }, 1000);
        }

        function applyZoom(v) { if(videoTrack) videoTrack.applyConstraints({advanced: [{zoom: parseFloat(v)}]}); }
        function toggleTorch() { 
            if(!videoTrack) return;
            const current = videoTrack.getSettings().torch;
            videoTrack.applyConstraints({advanced: [{torch: !current}]});
        }
        function restartCamera() { if(html5QrCode) html5QrCode.stop().then(() => initCamera()); }
        function addManualCode() {
            const val = document.getElementById("manual-input").value.trim();
            if(val) { handleScannedCode(val); document.getElementById("manual-input").value = ""; }
        }
        function toggleBulkUI() { localStorage.setItem("bulk_mode", document.getElementById("bulk-mode").checked); }
        function askClearAll() { openModal('clear-all'); }
        function askDeleteRow(c) { openModal('delete-one', c); }

        window.onload = () => { loadData(); initCamera(); };
    </script>
</body>
</html>